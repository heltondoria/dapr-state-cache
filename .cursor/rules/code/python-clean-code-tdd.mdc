---
globs: *.py
description: "Regras obrigat√≥rias de Clean Code e TDD para arquivos Python - baseado no guia completo de an√°lise e refatora√ß√£o"
---

# üéØ Regras Clean Code + TDD para Python

Esta regra implementa as diretrizes do guia completo definido em [prompt.md](mdc:prompt.md) e deve ser seguida rigorosamente em todos os arquivos Python do projeto.

## üìã Princ√≠pios Obrigat√≥rios

### ‚úÖ Concis√£o de Fun√ß√µes e M√©todos

- **M√°ximo 20 linhas** por m√©todo (Robert Martin)
- **Uma √∫nica responsabilidade** por fun√ß√£o
- **N√≠vel de abstra√ß√£o consistente** em cada m√©todo
- **Extra√ß√£o de m√©todos** quando exceder limites

### ‚úÖ Nomes Significativos

- Nomes devem **revelar inten√ß√£o** claramente
- **Evitar informa√ß√£o enganosa** ou abbrevia√ß√µes
- Usar nomes **pronunci√°veis e pesquis√°veis**
- Seguir conven√ß√µes Python (snake_case para fun√ß√µes/vari√°veis, PascalCase para classes)

### ‚úÖ Inje√ß√£o de Depend√™ncia

- **Inst√¢ncias passadas como par√¢metros** do construtor
- **Evitar instancia√ß√£o direta** dentro das classes
- **Usar abstra√ß√µes** (interfaces/protocols) em vez de implementa√ß√µes concretas
- **Configurar DI container** adequadamente

### ‚úÖ Uso Correto de Entidades/Exce√ß√µes

- **Exce√ß√µes sem√¢nticas** espec√≠ficas do dom√≠nio
- **Entidades de dom√≠nio** bem definidas
- **Respeitar arquitetura** (Clean/Hexagonal/Onion)
- **Separa√ß√£o clara** entre layers (domain, application, infrastructure)

## üö´ Code Smells a Evitar

### Viola√ß√µes Cr√≠ticas

- **DRY**: Eliminar c√≥digo duplicado
- **SRP**: Uma classe = uma responsabilidade
- **Long Method**: M√©todos > 20 linhas
- **Feature Envy**: M√©todo usando mais dados de outra classe
- **Data Clumps**: Par√¢metros sempre agrupados
- **Magic Numbers/Strings**: Usar constantes nomeadas

### Padr√µes Proibidos

```python
# ‚ùå EVITAR - Magic numbers
def calculate_tax(amount):
    return amount * 0.15  # Magic number!

# ‚úÖ CORRETO - Constante nomeada
TAX_RATE = 0.15
def calculate_tax(amount):
    return amount * TAX_RATE
```

## üß™ Requisitos de Testes (TDD)

### Cobertura Obrigat√≥ria

- **100% cobertura de linhas** (`coverage.py`)
- **100% cobertura de branches** (`coverage.py --branch`)
- **Todos os cen√°rios de exce√ß√£o** cobertos
- **Testes independentes** e repet√≠veis

### Nomenclatura de Testes

```python
def test_[m√©todo]_[cen√°rio]_[resultado_esperado](self):
    # Arrange
    # Act  
    # Assert
```

### Estrutura Obrigat√≥ria

- **Arrange-Act-Assert** (AAA) pattern
- **Mocks/stubs** para isolamento
- **Teste m√©todos privados** quando necess√°rio para coverage
- **Execu√ß√£o r√°pida** (< 1s para su√≠tes pequenas)

## üìä M√©tricas de Qualidade (Obrigat√≥rias)

| Aspecto | Meta Obrigat√≥ria | Valida√ß√£o |
|---------|------------------|-----------|
| **Cobertura de Linhas** | 100% | `make test-coverage` |
| **Cobertura de Branches** | 100% | `coverage.py --branch` |
| **Complexidade Ciclom√°tica** | < 6 por m√©todo | `make metrics` |
| **√çndice de Manutenibilidade** | > 20 | `make radon` |
| **Linhas por M√©todo** | < 21 | `make radon` |
| **C√≥digo N√£o Utilizado** | 0% | `make vulture` |
| **Type Safety** | 100% | `make mypy` |
| **Linting Score** | 10/10 | `make lint-check` |
| **Seguran√ßa** | Sem vulnerabilidades | `make security` |

## üõ†Ô∏è Comandos de Valida√ß√£o

### Workflow de Desenvolvimento R√°pido

```bash
# Verifica√ß√£o r√°pida durante desenvolvimento
make check          # Lint + tipos + formata√ß√£o
make fix            # Corre√ß√£o autom√°tica de problemas
```

### Execu√ß√£o Obrigat√≥ria Antes de Commit

```bash
# Valida√ß√£o completa
make validate       # An√°lise completa (lint + quality + testes)
make health         # Relat√≥rio de sa√∫de do projeto
```

### An√°lise de Qualidade Espec√≠fica

```bash
# Ferramentas individuais
make radon          # Complexidade e m√©tricas
make vulture        # C√≥digo n√£o utilizado
make mypy           # Verifica√ß√£o de tipos
make security       # An√°lise de seguran√ßa
make quality        # An√°lise completa de qualidade
make metrics        # M√©tricas de c√≥digo
```

### Flexibilidade de Uso

```bash
# An√°lise de arquivos espec√≠ficos
TARGET=src/module.py make mypy
TARGET=src/core/ make quality
```

### Ferramentas Necess√°rias

- **pytest** para testes unit√°rios
- **coverage.py** para cobertura
- **radon** para m√©tricas de complexidade
- **vulture** para detec√ß√£o de c√≥digo n√£o utilizado
- **mypy** para verifica√ß√£o de tipos
- **wily** para acompanhamento temporal
- **ruff** para linting e formata√ß√£o (inclui regras de seguran√ßa)
- **uv** como gerenciador de pacotes
- **Makefile** para automa√ß√£o

## üìê Princ√≠pios SOLID (Aplica√ß√£o Obrigat√≥ria)

- **S** - Single Responsibility Principle
- **O** - Open/Closed Principle  
- **L** - Liskov Substitution Principle
- **I** - Interface Segregation Principle
- **D** - Dependency Inversion Principle

## üö® Crit√©rios de Excel√™ncia (N√£o Negoci√°veis)

- ‚úÖ **Zero linting errors** (`make lint-check`)
- ‚úÖ **100% test coverage** (`make test-coverage`)
- ‚úÖ **Complexidade < 5** (`make metrics`)
- ‚úÖ **Zero c√≥digo n√£o utilizado** (`make vulture`)
- ‚úÖ **Type safety 100%** (`make mypy`)
- ‚úÖ **Sem vulnerabilidades de seguran√ßa** (`make security`)
- ‚úÖ **√çndice de manutenibilidade > 20** (`make radon`)
- ‚úÖ **Princ√≠pios SOLID aplicados**
- ‚úÖ **Arquitetura respeitada**
- ‚úÖ **Performance mantida**

### Valida√ß√£o Automatizada

```bash
make validate  # Executa todos os crit√©rios automaticamente
make health    # Relat√≥rio completo de sa√∫de do projeto
```

## üìñ Refer√™ncias Obrigat√≥rias

### Livros Base

- **Clean Code** - Robert C. Martin
- **Test-Driven Development: By Example** - Kent Beck
- **Clean Architecture** - Robert C. Martin

### Padr√µes de Teste

- **Arrange-Act-Assert** (AAA)
- **Test Doubles** (Mock, Stub, Fake, Spy)

---

‚ö†Ô∏è **IMPORTANTE**: Qualquer viola√ß√£o destas regras deve ser corrigida antes da submiss√£o do c√≥digo. Use o Makefile completo para an√°lise detalhada quando necess√°rio.
